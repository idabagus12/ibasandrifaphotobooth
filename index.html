<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ibas and Rifa's Photobooth</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lobster&display=swap"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="countdown" id="countdown"></div>
    <header>
      <h1>Ibas and Rifa's Photobooth</h1>
    </header>

    <main>
      <div class="container">
        <div class="camera-container">
          <video id="videoElement" autoplay playsinline></video>
          <div class="progress-indicator">
            <div class="progress-bar" id="photoProgress"></div>
          </div>
          <div class="controls">
            <button id="startCameraBtn">Mulai Kamera</button>
            <button id="captureBtn" class="accent-button" disabled>
              Ambil Foto 1 dari 4
            </button>
          </div>
        </div>

        <div class="result-container">
          <div class="photo-strip" id="photoStrip">
            <div class="photo-slot retake-slot" id="slot1" data-slot-index="0" draggable="true"></div>
                <button class="download-slot-btn" data-slot-index="0">Download Foto 1</button>
            <div class="photo-slot retake-slot" id="slot2" data-slot-index="1" draggable="true"></div>
                <button class="download-slot-btn" data-slot-index="1">Download Foto 2</button>
            <div class="photo-slot retake-slot" id="slot3" data-slot-index="2" draggable="true"></div>
                <button class="download-slot-btn" data-slot-index="2">Download Foto 3</button>
            <div class="photo-slot retake-slot" id="slot4" data-slot-index="3" draggable="true"></div>
                <button class="download-slot-btn" data-slot-index="1">Download Foto 4</button>
          </div>
          <img id="finalStrip" class="final-strip" alt="Final photo strip" />
          <div class="controls">
            <button id="resetBtn" disabled>Reset</button>
            <button id="downloadBtn" class="accent-button" disabled>
              Download
            </button>
          </div>
        </div>
      </div>

      <div class="options-container">
        <div class="options-grid">
          <div>
            <h2 class="section-title">Filter Foto</h2>
            <div class="filter-options">
              <div class="filter-option active" data-filter="none">Normal</div>
              <div class="filter-option" data-filter="grayscale">B&W</div>
              <div class="filter-option" data-filter="sepia">Vintage</div>
              <div class="filter-option" data-filter="saturate">Vibrant</div>
              <div class="filter-option" data-filter="contrast">
                High Contrast
              </div>
            </div>
          </div>

          <div>
            <h2 class="section-title">Warna Font</h2>
            <div class="color-options">
              <input type="color" id="frameColor" value="#222222" />
              <button id="applyColorBtn">Terapkan</button>
            </div>
          </div>

          <div>
            <h2 class="section-title">Warna Background</h2>
            <div class="color-options">
              <input type="color" id="bgColor" value="#ffffff" />
              <button id="applyBgColorBtn">Terapkan</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // DOM Elements
      const videoElement = document.getElementById('videoElement');
      const startCameraBtn = document.getElementById('startCameraBtn');
      const captureBtn = document.getElementById('captureBtn');
      const resetBtn = document.getElementById('resetBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const photoStrip = document.getElementById('photoStrip');
      const countdown = document.getElementById('countdown');
      const finalStrip = document.getElementById('finalStrip');
      const filterOptions = document.querySelectorAll('.filter-option');
      const frameColorPicker = document.getElementById('frameColor');
      const applyColorBtn = document.getElementById('applyColorBtn');
      const bgColorPicker = document.getElementById('bgColor');
      const applyBgColorBtn = document.getElementById('applyBgColorBtn');
      const photoProgress = document.getElementById('photoProgress');
      const retakeSlots = document.querySelectorAll('.retake-slot');

      // Variables
      let stream;
      let currentSlot = 0; // Index slot berikutnya yang akan diisi (0 hingga 3)
      let capturedPhotos = [];
      let currentFilter = 'none';
      let frameColor = '#222222';
      let bgColor = '#ffffff';
      
      // BARU: Tambahkan variabel untuk melacak slot yang akan diambil (penting untuk Retake)
      let slotIndexToCapture = 0;

      // Initialize
      function init() {
        startCameraBtn.addEventListener('click', startCamera);
        captureBtn.addEventListener('click', startCountdown);
        resetBtn.addEventListener('click', resetPhotos);
        downloadBtn.addEventListener('click', downloadComposite);
        applyColorBtn.addEventListener('click', applyFrameColor);
        applyBgColorBtn.addEventListener('click', applyBgColor);

        filterOptions.forEach((option) => {
          option.addEventListener('click', () => {
            filterOptions.forEach((opt) => opt.classList.remove('active'));
            option.classList.add('active');
            currentFilter = option.dataset.filter;
            applyFilter(videoElement, currentFilter);
          });
        });

        // Listener untuk Retake Selektif
        retakeSlots.forEach((slot, index) => {
          slot.addEventListener('dblclick', () => {
            if (capturedPhotos[index]) startRetake(index);
          });

          slot.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', index); // penting!
          });
          
          slot.addEventListener('dragover', (e) => e.preventDefault());

          slot.addEventListener('drop', (e) => {
            e.preventDefault();
            const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
            const targetIndex = parseInt(slot.dataset.slotIndex);
            if (sourceIndex === targetIndex) return;

            // Tukar foto di array
            const temp = capturedPhotos[sourceIndex];
            capturedPhotos[sourceIndex] = capturedPhotos[targetIndex];
            capturedPhotos[targetIndex] = temp;

                // Update UI slot
            updateSlotsUI();
          });
        });
        const downloadSlotBtns = document.querySelectorAll('.download-slot-btn');

        downloadSlotBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const index = parseInt(btn.dataset.slotIndex);
            if (capturedPhotos[index]) {
            const link = document.createElement('a');
            link.href = capturedPhotos[index];
            link.download = `photo_slot_${index + 1}.png`;
            link.click();
            } else {
            alert('Foto belum tersedia di slot ini.');
            }
        });
        });
        updateControlVisibility(); 
      }

      // Fungsi utilitas untuk mengontrol visibilitas tombol
      function updateControlVisibility() {
        // Kontrol Start/Stop Camera
        startCameraBtn.style.display = stream ? 'none' : 'inline-block';

        if (!stream) {
          captureBtn.disabled = true;
          return;
        }

        if (currentSlot >= 4) {
          // Selesai 4 Foto
          captureBtn.style.display = 'inline-block';
          captureBtn.disabled = false;
          captureBtn.textContent = 'Selesai';
        } else {
          // Sedang Proses (Slot 1, 2, 3, 4)
          captureBtn.style.display = 'inline-block';
          captureBtn.disabled = false;
          // Teks tombol selalu berdasarkan slot berikutnya yang akan diambil (currentSlot)
          captureBtn.textContent = `Ambil Foto ${currentSlot + 1} dari 4`;
        }

        // Tombol Reset/Download
        const filledCount = capturedPhotos.filter(p => p).length;
        resetBtn.disabled = filledCount === 0;
        downloadBtn.disabled = filledCount < 4;
      }

      // Start camera
      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false,
          });
          videoElement.srcObject = stream;
          updateControlVisibility();
        } catch (error) {
          console.error('Error accessing camera:', error);
          alert(
            'Error accessing camera. Please make sure your camera is enabled and try again.'
          );
        }
      }

      // Apply filter to video or image element
      function applyFilter(element, filter) {
        switch (filter) {
          case 'grayscale':
            element.style.filter = 'grayscale(100%)';
            break;
          case 'sepia':
            element.style.filter = 'sepia(70%)';
            break;
          case 'saturate':
            element.style.filter = 'saturate(180%)';
            break;
          case 'contrast':
            element.style.filter = 'contrast(150%)';
            break;
          default:
            element.style.filter = 'none';
        }
      }

      // Start countdown before capturing photo
      function startCountdown() {
        // Tentukan slot yang akan diisi. Jika bukan retake, gunakan currentSlot.
        // Jika sedang retake, slotIndexToCapture sudah diatur di startRetake().
        if (captureBtn.textContent === 'Selesai') {
          createPhotoStrip();
          return;
        }
        
        if (slotIndexToCapture === undefined || slotIndexToCapture === null) {
            slotIndexToCapture = currentSlot;
        }

        if (slotIndexToCapture >= 4) {
             // Seharusnya tidak terjadi jika updateControlVisibility() benar
             return;
        }

        // Nonaktifkan semua tombol saat countdown berjalan
        captureBtn.disabled = true;
        retakeSlots.forEach(slot => slot.style.pointerEvents = 'none'); // Nonaktifkan retake selektif

        let count = 3;
        countdown.textContent = count;
        countdown.style.display = 'flex';

        const countInterval = setInterval(() => {
          count--;
          if (count > 0) {
            countdown.textContent = count;
          } else {
            clearInterval(countInterval);
            countdown.style.display = 'none';
            capturePhoto(slotIndexToCapture); 
          }
        }, 1000);
      }

      // FUNGSI PERBAIKAN: Mulai proses Retake untuk slot tertentu
      function startRetake(targetSlotIndex) {
            // Kita ingin mengisi slot ini
            slotIndexToCapture = targetSlotIndex; 

            // Pastikan photo strip final hilang
            finalStrip.style.display = 'none';
            photoStrip.style.display = 'flex';
            
            // Hapus foto dari slot preview dan array
            document.getElementById(`slot${targetSlotIndex + 1}`).innerHTML = '';
            capturedPhotos[targetSlotIndex] = null;
            
            updateProgress(); 
            
            // Update tombol agar menunjukkan proses retake (Ambil Foto X dari 4)
            captureBtn.style.display = 'inline-block';
            captureBtn.disabled = false;
            captureBtn.textContent = `Ambil Ulang Foto ${targetSlotIndex + 1}`;

            // Langsung mulai countdown
            startCountdown();
            console.log(`Mulai Retake untuk Slot ${targetSlotIndex + 1}`);
      }

      function hslToRgb(h, s, l) {
          let r, g, b;

          if (s === 0) {
              r = g = b = l; // achromatic
          } else {
              const hue2rgb = (p, q, t) => {
                  if (t < 0) t += 1;
                  if (t > 1) t -= 1;
                  if (t < 1/6) return p + (q - p) * 6 * t;
                  if (t < 1/2) return q;
                  if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                  return p;
              };
              const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
              const p = 2 * l - q;
              r = hue2rgb(p, q, h + 1/3);
              g = hue2rgb(p, q, h);
              b = hue2rgb(p, q, h - 1/3);
          }

          return [r*255, g*255, b*255];
      }


      // Capture photo
      function capturePhoto(slotIndexToFill) {
        
        const canvas = document.createElement('canvas');
        const aspectRatio = 4 / 3;
        canvas.width = videoElement.videoWidth;
        canvas.height = canvas.width / aspectRatio;
        const context = canvas.getContext('2d');

        context.translate(canvas.width, 0);
        context.scale(-1, 1);

        const videoAspect = videoElement.videoWidth / videoElement.videoHeight;
        let sx = 0, sy = 0, sw = videoElement.videoWidth, sh = videoElement.videoHeight;
        if (videoAspect > aspectRatio) {
          sw = videoElement.videoHeight * aspectRatio;
          sx = (videoElement.videoWidth - sw) / 2;
        } else if (videoAspect < aspectRatio) {
          sh = videoElement.videoWidth / aspectRatio;
          sy = (videoElement.videoHeight - sh) / 2;
        }

        context.drawImage(videoElement, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
        context.setTransform(1, 0, 0, 1, 0, 0);

        // Terapkan filter jika ada
        if (currentFilter !== 'none') {
            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            // ... (Logika filter) ...
            switch (currentFilter) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg; data[i + 1] = avg; data[i + 2] = avg;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i + 1], b = data[i + 2];
                        data[i] = Math.min(255, r * 0.393 + g * 0.769 + b * 0.189);
                        data[i + 1] = Math.min(255, r * 0.349 + g * 0.686 + b * 0.168);
                        data[i + 2] = Math.min(255, r * 0.272 + g * 0.534 + b * 0.131);
                    }
                    break;
                case 'saturate':
                    for (let i = 0; i < data.length; i += 4) {
                        // konversi RGB ke HSL
                        let r = data[i] / 255, g = data[i+1] / 255, b = data[i+2] / 255;
                        const max = Math.max(r, g, b);
                        const min = Math.min(r, g, b);
                        let h, s, l = (max + min) / 2;

                        if (max === min) {
                            h = s = 0; // achromatic
                        } else {
                            const d = max - min;
                            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                            switch (max) {
                                case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                                case g: h = (b - r) / d + 2; break;
                                case b: h = (r - g) / d + 4; break;
                            }
                            h /= 6;
                        }

                        // tingkatkan saturasi
                        s = Math.min(1, s * 1.8);

                        // konversi HSL ke RGB lagi
                        [r, g, b] = hslToRgb(h, s, l);

                        data[i]   = isNaN(r) ? 0 : Math.min(255, Math.max(0, r));
                        data[i+1] = isNaN(g) ? 0 : Math.min(255, Math.max(0, g));
                        data[i+2] = isNaN(b) ? 0 : Math.min(255, Math.max(0, b));
                    }
                    break;
                case 'contrast':
                    const factor = 1.5;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, ((data[i] / 255 - 0.5) * factor + 0.5) * 255));
                        data[i + 1] = Math.min(255, Math.max(0, ((data[i + 1] / 255 - 0.5) * factor + 0.5) * 255));
                        data[i + 2] = Math.min(255, Math.max(0, ((data[i + 2] / 255 - 0.5) * factor + 0.5) * 255));
                    }
                    break;
            }
            context.putImageData(imageData, 0, 0);
        }

        const imgUrl = canvas.toDataURL('image/png');
        capturedPhotos[slotIndexToFill] = imgUrl;

        // Tampilkan di slot preview
        const img = document.createElement('img');
        img.src = imgUrl;
        const slot = document.getElementById(`slot${slotIndexToFill + 1}`);
        slot.innerHTML = '';
        slot.appendChild(img);
        
        // Aktifkan lagi Retake Selektif
        retakeSlots.forEach(slot => slot.style.pointerEvents = 'auto');

        // **PERBAIKAN LOGIKA UTAMA DI SINI:**
        // Jika slot yang diisi adalah slot yang belum pernah diisi (slotIndexToFill == currentSlot),
        // maka naikkan currentSlot untuk melanjutkan ke foto berikutnya.
        if (slotIndexToFill === currentSlot) {
            currentSlot++;
        }
        
        // Setelah foto diambil, reset slotIndexToCapture agar tombol kembali ke mode "Ambil Foto Berikutnya"
        slotIndexToCapture = currentSlot;

        updateProgress();
        
        const filledCount = capturedPhotos.filter(p => p).length;

        if (filledCount < 4) {
          captureBtn.textContent = `Ambil Foto ${filledCount + 1} dari 4`;
        } else {
          // jangan auto-generate â€” ubah menjadi state "Selesai" dan biarkan user klik
          captureBtn.textContent = 'Selesai';
          captureBtn.disabled = false;
          }

        updateControlVisibility();
      }

      // Update progress bar
      function updateProgress() {
        const filledSlots = capturedPhotos.filter(p => p).length;
        const progress = (filledSlots / 4) * 100;
        photoProgress.style.width = `${progress}%`;
      }

      // Create final photo strip
      function createPhotoStrip() {
        if (capturedPhotos.filter(p => p).length < 4) return;
        
        const canvas = document.createElement('canvas');
        const padding = 10;
        const photoWidth = 300;
        const photoHeight = photoWidth * (3 / 4);
        const textHeight = 60;
        const textPaddingTop = 25;
        const textSpacing = 10;

        const sideMargin = 20;
        const canvasWidth = photoWidth + sideMargin * 2;
        const totalPhotoHeight = photoHeight * 4 + padding * 3;
        const canvasHeight =
          totalPhotoHeight + textHeight + sideMargin * 2 + textPaddingTop;

        canvas.width = canvasWidth;
        canvas.height = canvasHeight;

        const ctx = canvas.getContext('2d');

        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const startX = sideMargin;
        const startY = sideMargin;

        const photoPromises = capturedPhotos.map((photo, index) => {
             return new Promise(resolve => {
                const img = new Image();
                img.onload = () => {
                    const y = startY + index * (photoHeight + padding);
                    ctx.drawImage(img, startX, y, photoWidth, photoHeight);
                    resolve();
                };
                img.src = photo;
            });
        });

        Promise.all(photoPromises).then(() => {
            ctx.fillStyle = frameColor;
            ctx.textAlign = 'center';

            const textY = canvas.height - sideMargin - textHeight + textPaddingTop;

            ctx.font = 'bold 24px Lobster, sans-serif';
            ctx.fillText(' Ibas and Rifa`s World ', canvas.width / 2, textY);

            ctx.font = '14px Lobster, sans-serif';
            ctx.fillText(
                new Date().toLocaleDateString(),
                canvas.width / 2,
                textY + textSpacing + 14
            );

            finalStrip.src = canvas.toDataURL('image/png');
            finalStrip.style.display = 'block';
            photoStrip.style.display = 'none';
            // Nonaktifkan Retake Selektif setelah strip dibuat
            retakeSlots.forEach(slot => slot.style.pointerEvents = 'auto'); 
        });
      }

      // Reset photos
      function resetPhotos() {
        currentSlot = 0;
        slotIndexToCapture = 0;
        capturedPhotos = [];
        for (let i = 1; i <= 4; i++) {
          document.getElementById(`slot${i}`).innerHTML = '';
        }
        photoProgress.style.width = '0%';
        finalStrip.style.display = 'none';
        photoStrip.style.display = 'flex';
        // Aktifkan lagi Retake Selektif
        retakeSlots.forEach((slot, index) => {
          slot.addEventListener('dblclick', () => {
            if (capturedPhotos[index]) { // hanya jika ada foto
              startRetake(index);
            }
          });
        });
        updateControlVisibility();
      }

      // Download composite
      function downloadComposite() {
        const link = document.createElement('a');
        link.download =
          'photobooth_strip_' + new Date().toISOString().slice(0, 10) + '.png';
        link.href = finalStrip.src;
        link.click();
      }

      // Apply frame color
      function applyFrameColor() {
        frameColor = frameColorPicker.value;
        if (capturedPhotos.filter(p => p).length === 4) {
          createPhotoStrip();
        }
      }

      // Apply background color
      function applyBgColor() {
        bgColor = bgColorPicker.value;
        if (capturedPhotos.filter(p => p).length === 4) {
          createPhotoStrip();
        }
      }

      function updateSlotsUI() {
          capturedPhotos.forEach((photo, index) => {
              const slot = document.getElementById(`slot${index + 1}`);
              slot.innerHTML = '';
              if (photo) {
                  const img = document.createElement('img');
                  img.src = photo;
                  slot.appendChild(img);
              }
          });
      }

      // Initialize on load
      window.addEventListener('load', init);
    </script>
  </body>
</html>
